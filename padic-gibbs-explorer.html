<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-adic Gibbs Regression Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.2em;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #ecf0f1;
            font-size: 0.9em;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        input[type="number"], textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 14px;
        }
        
        textarea {
            min-height: 120px;
            font-family: monospace;
            resize: vertical;
        }
        
        .value-display {
            font-size: 0.9em;
            color: #3498db;
            font-weight: 600;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #8e44ad);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-panel h3 {
            margin-top: 0;
            color: #3498db;
            font-size: 1.3em;
        }
        
        .iteration-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .math-explanation {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            line-height: 1.6;
        }
        
        .math-explanation h3 {
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .formula {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .data-input {
            grid-column: span 2;
        }
        
        @media (max-width: 768px) {
            .results {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>P-adic Gibbs Regression Explorer</h1>
        <p class="subtitle">Interactive exploration of Gibbs-style p-adic linear regression with Boltzmann sampling</p>
        
        <div class="math-explanation">
            <h3>Understanding P-adic Regression</h3>
            <p>This game implements Zubarev's p-adic polynomial regression using Gibbs sampling. Unlike traditional regression that minimizes Euclidean distance, p-adic regression uses the p-adic norm |·|_p where smaller values indicate better fits.</p>
            
            <div class="formula">
                P-adic valuation: v_p(n) = max{k : p^k divides n}<br>
                P-adic norm: |n|_p = p^(-v_p(n))<br>
                Loss function: L(w) = (1/N) Σ |y_i - (w_0 + Σ w_j x_ij)|_p
            </div>
            
            <p>The Gibbs sampler proposes parameter updates w_new = w_old + ξ and accepts them with probability proportional to exp(-β(L_new - L_old)).</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="prime">Prime p:</label>
                <input type="number" id="prime" min="2" value="2" step="1">
            </div>
            
            <div class="control-group">
                <label for="beta">Temperature β:</label>
                <input type="range" id="beta" min="0.1" max="2.0" value="0.4" step="0.1">
                <span class="value-display" id="beta-value">0.4</span>
            </div>
            
            <div class="control-group">
                <label for="iterations">Iterations:</label>
                <input type="number" id="iterations" min="50" value="200" step="50">
            </div>
            
            <div class="control-group">
                <label for="candidates">Candidates per step:</label>
                <input type="range" id="candidates" min="10" max="100" value="40" step="10">
                <span class="value-display" id="candidates-value">40</span>
            </div>
            
            <div class="control-group">
                <label for="digits">P-adic digits:</label>
                <input type="range" id="digits" min="1" max="5" value="3" step="1">
                <span class="value-display" id="digits-value">3</span>
            </div>
            
            <div class="control-group data-input">
                <label for="data">Training Data (CSV format: x1,x2,...,y):</label>
                <textarea id="data" placeholder="x1,x2,y
1,1,6
2,3,11
4,2,11
5,0,9">x1,x2,y
1,1,6
2,3,11
4,2,11
5,0,9</textarea>
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="runRegression()">Run P-adic Regression</button>
            <button onclick="clearResults()">Clear Results</button>
            <button onclick="loadSampleData()">Load Sample Data</button>
        </div>
        
        <div class="results">
            <div class="result-panel">
                <h3>Sampling Progress</h3>
                <div class="iteration-log" id="log"></div>
            </div>
            
            <div class="result-panel">
                <h3>Loss Convergence</h3>
                <div id="trend-info" style="margin-bottom: 10px; font-weight: 600; color: #e74c3c;"></div>
                <div class="chart-container">
                    <canvas id="lossChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="result-panel" style="margin-top: 20px;">
            <h3>Final Results</h3>
            <div id="final-results"></div>
        </div>
    </div>

    <script>
        // Prime checking function
        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function validatePrime() {
            const primeInput = document.getElementById('prime');
            const p = parseInt(primeInput.value);
            
            if (!isPrime(p)) {
                alert(`${p} is not a prime number. Please enter a prime number.`);
                primeInput.value = 2; // Reset to default prime
                return false;
            }
            return true;
        }

        // P-adic mathematical functions
        function vp(n, p) {
            if (n === 0) return 60; // "infinity"
            let v = 0;
            while (n % p === 0) {
                n = Math.floor(n / p);
                v++;
            }
            return v;
        }

        function padicNorm(n, p) {
            return n === 0 ? 0.0 : Math.pow(p, -vp(n, p));
        }

        function lossPadicMean(w, A, y, p) {
            const residuals = y.map((yi, i) => {
                const prediction = w[0] + A[i].reduce((sum, aij, j) => sum + aij * w[j + 1], 0);
                return yi - prediction;
            });
            
            const norms = residuals.map(r => padicNorm(Math.round(r), p));
            return norms.reduce((sum, norm) => sum + norm, 0) / norms.length;
        }

        function sampleProposals(p, K1, digits, num) {
            const range = Math.pow(p, digits);
            const half = Math.floor(range / 2);
            const proposals = [];
            
            for (let i = 0; i < num; i++) {
                const proposal = [];
                for (let j = 0; j < K1; j++) {
                    proposal.push(Math.floor(Math.random() * range) - half);
                }
                proposals.push(proposal);
            }
            return proposals;
        }

        function gibbsStep(w, lossNow, A, y, p, beta, digits, numCands) {
            const K1 = w.length;
            const candidates = sampleProposals(p, K1, digits, numCands);
            const deltas = [];
            const losses = [];
            
            for (const xi of candidates) {
                const wNew = w.map((wi, i) => wi + xi[i]);
                const lossNew = lossPadicMean(wNew, A, y, p);
                const delta = lossNew - lossNow;
                deltas.push(delta);
                losses.push(lossNew);
            }
            
            // Boltzmann weights
            const weights = deltas.map(delta => Math.exp(-beta * delta));
            const Z = weights.reduce((sum, w) => sum + w, 0);
            const probs = weights.map(w => w / Z);
            
            // Sample from probability distribution
            const r = Math.random();
            let cumProb = 0;
            let k = 0;
            for (let i = 0; i < probs.length; i++) {
                cumProb += probs[i];
                if (r <= cumProb) {
                    k = i;
                    break;
                }
            }
            
            const wNew = w.map((wi, i) => wi + candidates[k][i]);
            return {
                w: wNew,
                loss: losses[k],
                delta: candidates[k]
            };
        }

        function parseData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => parseInt(v.trim()));
                data.push(values);
            }
            
            // Last column is y, rest are features
            const y = data.map(row => row[row.length - 1]);
            const A = data.map(row => row.slice(0, -1));
            
            return { A, y };
        }

        let lossChart = null;

        async function runRegression() {
            if (!validatePrime()) return;
            
            const p = parseInt(document.getElementById('prime').value);
            const beta = parseFloat(document.getElementById('beta').value);
            const iterations = parseInt(document.getElementById('iterations').value);
            const candidates = parseInt(document.getElementById('candidates').value);
            const digits = parseInt(document.getElementById('digits').value);
            const csvData = document.getElementById('data').value;
            
            try {
                const { A, y } = parseData(csvData);
                const K = A[0].length;
                const K1 = K + 1;
                
                let w = new Array(K1).fill(0);
                let lossNow = lossPadicMean(w, A, y, p);
                
                const log = document.getElementById('log');
                const finalResults = document.getElementById('final-results');
                
                log.innerHTML = `★ Starting loss: ${lossNow.toExponential(3)}, w = [${w.join(', ')}]\n`;
                
                const lossHistory = [lossNow];
                const coefficientHistory = [w.slice()]; // Store copy of initial coefficients
                
                for (let it = 1; it <= iterations; it++) {
                    const result = gibbsStep(w, lossNow, A, y, p, beta, digits, candidates);
                    w = result.w;
                    const lossNew = result.loss;
                    const delta = result.delta;
                    
                    const moveStr = `[${delta.join(', ')}]`.padEnd(20);
                    log.innerHTML += `[${it.toString().padStart(3, '0')}] Δw=${moveStr} loss ${lossNow.toExponential(3)} → ${lossNew.toExponential(3)}\n`;
                    log.scrollTop = log.scrollHeight;
                    
                    lossNow = lossNew;
                    lossHistory.push(lossNow);
                    coefficientHistory.push(w.slice()); // Store copy of current coefficients
                    
                    if (it % 10 === 0) {
                        updateChart(lossHistory, coefficientHistory);
                        await new Promise(resolve => setTimeout(resolve, 10)); // Allow UI update
                    }
                }
                
                log.innerHTML += '✔ Finished\n';
                
                finalResults.innerHTML = `
                    <h4>Final Coefficients (intercept first):</h4>
                    ${w.map((coeff, i) => `<div>w[${i}] = ${coeff}</div>`).join('')}
                    <h4>Final Loss:</h4>
                    <div>${lossNow.toExponential(6)}</div>
                `;
                
                updateChart(lossHistory, coefficientHistory);
                
            } catch (error) {
                document.getElementById('log').innerHTML += `❌ Error: ${error.message}\n`;
            }
        }

        function calculateTrendLine(lossHistory) {
            const n = lossHistory.length;
            const x = Array.from({length: n}, (_, i) => i);
            const y = lossHistory.map(loss => Math.log(loss)); // Use log for exponential trend
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            const trendLine = x.map(xi => Math.exp(intercept + slope * xi));
            const lossPerIteration = Math.exp(slope) - 1; // Convert back from log space
            
            return { trendLine, lossPerIteration };
        }

        function updateChart(lossHistory, coefficientHistory) {
            const ctx = document.getElementById('lossChart').getContext('2d');
            
            if (lossChart) {
                lossChart.destroy();
            }
            
            const { trendLine, lossPerIteration } = calculateTrendLine(lossHistory);
            
            lossChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: lossHistory.map((_, i) => i),
                    datasets: [{
                        label: 'P-adic Loss',
                        data: lossHistory.map((loss, i) => ({
                            x: i,
                            y: loss,
                            coefficients: coefficientHistory[i]
                        })),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'Trend Line',
                        data: trendLine,
                        borderColor: '#e74c3c',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Iteration ${context[0].parsed.x}`;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) { // Loss dataset
                                        const coeffs = context.raw.coefficients;
                                        const coeffStr = coeffs.map((c, i) => `w[${i}]=${c}`).join(', ');
                                        return [
                                            `Loss: ${context.parsed.y.toExponential(3)}`,
                                            `Coefficients: [${coeffStr}]`
                                        ];
                                    } else {
                                        return `Trend: ${context.parsed.y.toExponential(3)}`;
                                    }
                                }
                            },
                            titleColor: 'white',
                            bodyColor: 'white',
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Iteration', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Loss', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            type: 'logarithmic'
                        }
                    }
                }
            });
            
            // Update trend information
            const trendInfo = document.getElementById('trend-info');
            if (trendInfo) {
                const percentChange = (lossPerIteration * 100).toFixed(2);
                const direction = lossPerIteration < 0 ? 'decreasing' : 'increasing';
                trendInfo.innerHTML = `Trend: Loss ${direction} by ${Math.abs(percentChange)}% per iteration`;
            }
        }

        function clearResults() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('final-results').innerHTML = '';
            if (lossChart) {
                lossChart.destroy();
                lossChart = null;
            }
        }

        function loadSampleData() {
            document.getElementById('data').value = `x1,x2,y
1,1,6
2,3,11
4,2,11
5,0,9
3,1,8
1,4,9
6,2,14
0,5,10`;
        }

        // Update value displays for sliders only
        function updateValueDisplays() {
            document.getElementById('beta-value').textContent = document.getElementById('beta').value;
            document.getElementById('candidates-value').textContent = document.getElementById('candidates').value;
            document.getElementById('digits-value').textContent = document.getElementById('digits').value;
        }

        // Add event listeners
        document.getElementById('prime').addEventListener('blur', validatePrime);
        document.getElementById('beta').addEventListener('input', updateValueDisplays);
        document.getElementById('candidates').addEventListener('input', updateValueDisplays);
        document.getElementById('digits').addEventListener('input', updateValueDisplays);

        // Initialize displays
        updateValueDisplays();
    </script>
</body>
</html>